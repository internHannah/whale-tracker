<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>AI Whale Watch</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        font-family:
          system-ui,
          -apple-system,
          BlinkMacSystemFont,
          "Segoe UI",
          sans-serif;
        margin: 0;
        padding: 0;
        background: #050816;
        color: #e5e7eb;
      }

      .page {
        max-width: 1280px;
        margin: 0 auto;
        padding: 24px 16px 48px;
      }

      h1 {
        font-size: 32px;
        margin-bottom: 4px;
      }

      .subtitle {
        font-size: 14px;
        color: #9ca3af;
        margin-bottom: 20px;
      }

      .card {
        background: rgba(17, 24, 39, 0.95);
        border-radius: 16px;
        padding: 16px 18px;
        margin-bottom: 20px;
        border: 1px solid rgba(55, 65, 81, 0.8);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.45);
      }

      .card-title {
        font-size: 15px;
        font-weight: 600;
        margin-bottom: 6px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .badge {
        font-size: 11px;
        padding: 2px 6px;
        border-radius: 999px;
        background: rgba(56, 189, 248, 0.15);
        color: #7dd3fc;
        border: 1px solid rgba(56, 189, 248, 0.4);
      }

      .summary-text {
        font-size: 14px;
        line-height: 1.5;
        color: #d1d5db;
        white-space: pre-wrap;
      }

      .summary-meta {
        margin-top: 6px;
        font-size: 12px;
        color: #6b7280;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }

      thead {
        background: rgba(17, 24, 39, 0.95);
      }

      th,
      td {
        padding: 8px 10px;
        text-align: left;
        border-bottom: 1px solid rgba(31, 41, 55, 0.9);
      }

      th {
        font-weight: 500;
        font-size: 12px;
        color: #9ca3af;
      }

      tr:nth-child(even) td {
        background: rgba(15, 23, 42, 0.7);
      }

      .amount {
        font-variant-numeric: tabular-nums;
        font-weight: 500;
        color: #a5b4fc;
      }

      .address {
        font-family:
          ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 12px;
      }

      a.addr-link {
        color: #6ee7b7;
        text-decoration: none;
      }

      a.addr-link:hover {
        text-decoration: underline;
      }

      .chip {
        display: inline-block;
        font-size: 11px;
        padding: 2px 6px;
        border-radius: 999px;
        background: rgba(79, 70, 229, 0.25);
        color: #c4b5fd;
        border: 1px solid rgba(129, 140, 248, 0.6);
      }

      .error {
        color: #fb7185;
        font-size: 13px;
        margin-top: 6px;
      }

      .loading {
        font-size: 13px;
        color: #9ca3af;
      }

      .layout {
        display: flex;
        gap: 18px;
        align-items: flex-start;
      }

      .main-column {
        flex: 2.3;
        min-width: 0;
      }

      .sidebar {
        flex: 1;
        min-width: 280px;
      }

      @media (max-width: 900px) {
        .layout {
          flex-direction: column;
        }
        .sidebar {
          width: 100%;
        }
      }

      .table-container {
        max-height: 420px;
        overflow-y: auto;
        overflow-x: auto;
        border-radius: 10px;
        scrollbar-gutter: stable both-edges;
        border: 1px solid rgba(55, 65, 81, 0.6);
        box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.25);
      }

      .table-container::-webkit-scrollbar {
        width: 8px;
      }

      .table-container::-webkit-scrollbar-track {
        background: rgba(30, 41, 59, 0.4);
        border-radius: 8px;
      }

      .table-container::-webkit-scrollbar-thumb {
        background: rgba(100, 116, 139, 0.8);
        border-radius: 8px;
      }

      .table-container::-webkit-scrollbar-thumb:hover {
        background: rgba(148, 163, 184, 0.95);
      }

      .table-container tr.row-new {
        animation: flashRow 0.8s ease-out;
      }

      @keyframes flashRow {
        0% {
          background-color: rgba(56, 189, 248, 0.28); /* teal-ish flash */
        }
        100% {
          background-color: transparent; /* hand off to normal row bg */
        }
      }

      .tab-header {
        display: inline-flex;
        background: rgba(15, 23, 42, 0.9);
        border-radius: 999px;
        padding: 2px;
        margin-left: auto;
      }

      .tab-btn {
        border: none;
        background: transparent;
        color: #9ca3af;
        font-size: 11px;
        padding: 4px 10px;
        border-radius: 999px;
        cursor: pointer;
      }

      .tab-btn.active {
        background: linear-gradient(135deg, #4f46e5, #0ea5e9);
        color: white;
      }

      .tab-panel {
        display: none;
        margin-top: 8px;
      }

      .tab-panel.active {
        display: block;
      }

      .timezone-indicator {
        font-size: 11px;
        color: #9ca3af;
        opacity: 0.85;
        margin-top: 4px;
        margin-bottom: 6px;
        padding-left: 4px;
        user-select: none;
        pointer-events: none;
        letter-spacing: 0.2px;
      }
      .timezone-indicator span {
        color: #e5e7eb;
        font-weight: 500;
      }

      #pagination {
        margin-top: 8px;
        font-size: 12px;
        color: #9ca3af;
        display: none;
        justify-content: flex-end;
        align-items: center;
        gap: 8px;
      }

      #pagination button {
        padding: 3px 8px;
        border-radius: 999px;
        border: 1px solid rgba(75, 85, 99, 0.9);
        background: rgba(15, 23, 42, 0.9);
        color: #e5e7eb;
        cursor: pointer;
      }

      #pagination .page-number-btn.active {
        background: linear-gradient(135deg, #4f46e5, #0ea5e9);
        color: white;
        border-color: transparent;
      }

      .page-ellipsis {
        padding: 0 4px;
        opacity: 0.65;
      }

      #chat-widget-bubble {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: linear-gradient(135deg, #4f46e5, #06b6d4);
        color: white;
        font-size: 12px;
        padding: 8px 12px;
        border-radius: 999px;
        display: flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
        z-index: 40;
      }

      #chat-widget-panel {
        position: fixed;
        bottom: 80px;
        right: 20px;
        width: 340px;
        max-width: calc(100% - 40px);
        z-index: 50;
        display: none;
      }

      #chat-widget-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
      }

      #chat-close-btn {
        border: none;
        background: transparent;
        color: #9ca3af;
        cursor: pointer;
        font-size: 16px;
        line-height: 1;
      }

      .filter-group {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 6px;
      }

      .filter-pill {
        border-radius: 999px;
        border: 1px solid rgba(55, 65, 81, 0.9);
        background: rgba(15, 23, 42, 0.9);
        color: #9ca3af;
        font-size: 11px;
        padding: 3px 8px;
        cursor: pointer;
      }

      .filter-pill.active {
        background: linear-gradient(135deg, #4f46e5, #0ea5e9);
        color: #ffffff;
        border-color: transparent;
      }
    </style>
  </head>
  <body>
    <div class="page">
      <h1>AI Whale Watch</h1>
      <div class="subtitle">
        Real Ethereum whale transfers &amp; AI commentary (mini Tie-style
        prototype).
      </div>

      <div class="layout">
        <!-- MAIN COLUMN: TABLE + WALLET DRILL-DOWN -->
        <div class="main-column">
          <div class="card">
            <div class="card-title" style="margin-bottom: 6px">
              Recent Whale Transfers
              <span class="chip">Whales (USDC, USDT, ETH, WBTC)</span>
            </div>
            <div class="timezone-indicator">
              Local time: <span id="tz"></span>
            </div>

            <div
              style="
                display: flex;
                flex-wrap: wrap;
                gap: 12px;
                margin-bottom: 8px;
                font-size: 12px;
                color: #9ca3af;
                align-items: center;
              "
            >
              <div>
                <span>Min amount: </span>
                <input
                  id="filter-min-amount"
                  type="number"
                  value="100"
                  min="0"
                  step="10"
                  style="
                    width: 80px;
                    padding: 2px 6px;
                    border-radius: 6px;
                    border: 1px solid rgba(55, 65, 81, 0.9);
                    background: rgba(15, 23, 42, 0.9);
                    color: #e5e7eb;
                  "
                />
              </div>
              <div class="filter-group">
                <span style="margin-right: 4px">Tokens:</span>
                <button
                  id="token-all"
                  class="filter-pill filter-token-btn active"
                  data-token="ALL"
                >
                  All
                </button>
                <button class="filter-pill filter-token-btn" data-token="ETH">
                  ETH
                </button>
                <button class="filter-pill filter-token-btn" data-token="USDC">
                  USDC
                </button>
                <button class="filter-pill filter-token-btn" data-token="USDT">
                  USDT
                </button>
                <button class="filter-pill filter-token-btn" data-token="WBTC">
                  WBTC
                </button>
              </div>

              <div class="filter-group">
                <span style="margin-right: 4px">Pattern:</span>
                <button
                  id="pattern-all"
                  class="filter-pill filter-pattern-btn active"
                  data-pattern="ALL"
                >
                  All
                </button>
                <button
                  class="filter-pill filter-pattern-btn"
                  data-pattern="Accumulator-like"
                >
                  Accumulator-like
                </button>
                <button
                  class="filter-pill filter-pattern-btn"
                  data-pattern="Distributor-like"
                >
                  Distributor-like
                </button>
                <button
                  class="filter-pill filter-pattern-btn"
                  data-pattern="Balanced"
                >
                  Balanced
                </button>
              </div>

              <button
                id="filter-apply"
                style="
                  padding: 4px 12px;
                  border-radius: 999px;
                  border: none;
                  font-size: 12px;
                  font-weight: 500;
                  cursor: pointer;
                  background: linear-gradient(135deg, #4b5563, #0ea5e9);
                  color: white;
                "
              >
                Apply
              </button>
            </div>

            <div id="table-loading" class="loading">
              Loading whale transfers‚Ä¶
            </div>
            <div id="table-error" class="error" style="display: none"></div>
            <div class="table-container">
              <table id="whale-table" style="display: none">
                <thead>
                  <tr>
                    <th>Amount</th>
                    <th>Token</th>
                    <th>From</th>
                    <th>To</th>
                    <th>Pattern</th>
                    <th>Block</th>
                    <th>Observed</th>
                  </tr>
                </thead>
                <tbody id="whale-tbody"></tbody>
              </table>
            </div>
            <!-- Pagination -->
            <div id="pagination">
              <button id="page-prev">Prev</button>
              <div id="page-numbers"></div>
              <button id="page-next">Next</button>
            </div>
          </div>

          <!-- Wallet drill-down BELOW table -->
          <div class="card" id="wallet-card">
            <div class="card-title" style="margin-bottom: 8px">
              Wallet Drill-down
              <span class="badge">Per-wallet view</span>
            </div>
            <div id="wallet-empty" class="loading">
              Click a wallet address in the table to see its flow profile in
              this snapshot.
            </div>
            <div
              id="wallet-body"
              style="display: none; font-size: 13px; color: #d1d5db"
            >
              <div style="margin-bottom: 8px; font-size: 12px; color: #9ca3af">
                Snapshot based on the current set of whale transfers only (not
                full on-chain history).
              </div>
              <div style="margin-bottom: 8px">
                <div style="font-size: 11px; color: #9ca3af">
                  Selected wallet
                </div>
                <div
                  id="wallet-address"
                  class="address"
                  style="font-size: 12px"
                ></div>
              </div>
              <div
                style="
                  display: flex;
                  flex-wrap: wrap;
                  gap: 12px;
                  margin-bottom: 8px;
                "
              >
                <div>
                  <div style="font-size: 11px; color: #9ca3af">
                    Total inflow
                  </div>
                  <div id="wallet-inflow" style="font-weight: 600">‚Äì</div>
                </div>
                <div>
                  <div style="font-size: 11px; color: #9ca3af">
                    Total outflow
                  </div>
                  <div id="wallet-outflow" style="font-weight: 600">‚Äì</div>
                </div>
                <div>
                  <div style="font-size: 11px; color: #9ca3af">Net flow</div>
                  <div id="wallet-net" style="font-weight: 600">‚Äì</div>
                </div>
                <div>
                  <div style="font-size: 11px; color: #9ca3af">
                    Transfers involving wallet
                  </div>
                  <div id="wallet-txcount" style="font-weight: 600">‚Äì</div>
                </div>
              </div>
              <div>
                <div style="font-size: 11px; color: #9ca3af">
                  Role in this flow window
                </div>
                <div
                  id="wallet-role"
                  style="font-weight: 600; font-size: 13px"
                ></div>
              </div>
            </div>
            <div id="wallet-error" class="error" style="display: none"></div>
          </div>
        </div>

        <!-- SIDEBAR: AI WHALE INTELLIGENCE PANEL -->
        <div class="sidebar">
          <div class="card" id="intel-card">
            <div class="card-title">
              AI Whale Intelligence
              <span class="badge">Analytics</span>
              <div class="tab-header">
                <button
                  class="tab-btn active"
                  data-tab="overview"
                  id="tab-btn-overview"
                >
                  Overview
                </button>
                <button class="tab-btn" data-tab="flow" id="tab-btn-flow">
                  Flow
                </button>
                <button class="tab-btn" data-tab="report" id="tab-btn-report">
                  Report
                </button>
              </div>
            </div>
            <div
              style="
                font-size: 11px;
                color: #9ca3af;
                margin-bottom: 8px;
                margin-top: 4px;
              "
            >
              AI context window:
              <select
                id="ai-context-limit"
                style="
                  padding: 2px 6px;
                  border-radius: 6px;
                  border: 1px solid rgba(55, 65, 81, 0.9);
                  background: rgba(15, 23, 42, 0.9);
                  color: #e5e7eb;
                "
              >
                <option value="50">Last 50 transfers</option>
                <option value="200" selected>Last 200 transfers</option>
                <option value="500">Last 500 transfers</option>
                <option value="1000">Last 1000 transfers</option>
              </select>
            </div>
            <div class="card" id="intelligence-card">
              <div
                style="
                  display: flex;
                  align-items: center;
                  justify-content: space-between;
                  gap: 12px;
                  margin-bottom: 8px;
                "
              >
                <div class="card-title" style="margin-bottom: 4px">
                  AI Whale Intelligence
                </div>

                <div id="download-menu" style="position: relative">
                  <button
                    id="download-menu-toggle"
                    style="
                      padding: 6px 12px;
                      border-radius: 999px;
                      border: 1px solid rgba(75, 85, 99, 0.9);
                      background: rgba(15, 23, 42, 0.95);
                      color: #e5e7eb;
                      font-size: 12px;
                      font-weight: 500;
                      cursor: pointer;
                    "
                  >
                    ‚¨á Download
                  </button>
                  <div
                    id="download-menu-panel"
                    style="
                      display: none;
                      position: absolute;
                      right: 0;
                      top: 110%;
                      background: rgba(15, 23, 42, 0.98);
                      border-radius: 12px;
                      border: 1px solid rgba(55, 65, 81, 0.9);
                      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.6);
                      min-width: 190px;
                      z-index: 20;
                    "
                  >
                    <button
                      data-action="data"
                      style="
                        width: 100%;
                        padding: 8px 12px;
                        background: transparent;
                        border: none;
                        color: #e5e7eb;
                        font-size: 13px;
                        text-align: left;
                        cursor: pointer;
                      "
                    >
                      Download data (.csv)
                    </button>
                    <button
                      data-action="report"
                      style="
                        width: 100%;
                        padding: 8px 12px;
                        background: transparent;
                        border: none;
                        color: #e5e7eb;
                        font-size: 13px;
                        text-align: left;
                        cursor: pointer;
                      "
                    >
                      Download analysis (.txt)
                    </button>
                    <button
                      data-action="pdf"
                      style="
                        width: 100%;
                        padding: 8px 12px;
                        background: transparent;
                        border: none;
                        color: #e5e7eb;
                        font-size: 13px;
                        text-align: left;
                        cursor: pointer;
                      "
                    >
                      Print / save as PDF
                    </button>
                  </div>
                </div>
              </div>

              <!-- Tab: Overview (uses summary/LLM) -->
              <div class="tab-panel active" id="tab-overview">
                <div id="summary-loading" class="loading">Loading summary‚Ä¶</div>
                <div
                  id="summary-text"
                  class="summary-text"
                  style="display: none"
                ></div>
                <div
                  id="summary-meta"
                  class="summary-meta"
                  style="display: none"
                ></div>
                <div
                  id="summary-error"
                  class="error"
                  style="display: none"
                ></div>
              </div>

              <!-- Tab: Flow Intelligence (metrics) -->
              <div class="tab-panel" id="tab-flow">
                <div id="metrics-loading" class="loading">
                  Waiting for whale data‚Ä¶
                </div>
                <div
                  id="metrics-body"
                  style="display: none; font-size: 13px; color: #d1d5db"
                >
                  <div
                    style="
                      display: flex;
                      flex-wrap: wrap;
                      gap: 12px;
                      margin-bottom: 8px;
                    "
                  >
                    <div>
                      <div style="font-size: 11px; color: #9ca3af">
                        Total volume
                      </div>
                      <div id="metric-volume" style="font-weight: 600">‚Äì</div>
                    </div>
                    <div>
                      <div style="font-size: 11px; color: #9ca3af">
                        Largest transfer
                      </div>
                      <div id="metric-largest" style="font-weight: 600">‚Äì</div>
                    </div>
                    <div>
                      <div style="font-size: 11px; color: #9ca3af">
                        Unique wallets
                      </div>
                      <div id="metric-unique-wallets" style="font-weight: 600">
                        ‚Äì
                      </div>
                    </div>
                    <div>
                      <div style="font-size: 11px; color: #9ca3af">
                        Concentration
                      </div>
                      <div id="metric-concentration" style="font-weight: 600">
                        ‚Äì
                      </div>
                    </div>
                  </div>

                  <div style="margin-top: 4px">
                    <div style="font-size: 11px; color: #9ca3af">
                      Top wallets in this snapshot
                    </div>
                    <div
                      id="metric-top-wallets"
                      style="font-size: 12px; margin-top: 4px"
                    ></div>
                  </div>
                </div>
                <div
                  id="metrics-meta"
                  class="summary-meta"
                  style="display: none"
                ></div>
                <div
                  id="metrics-error"
                  class="error"
                  style="display: none"
                ></div>
              </div>

              <!-- Tab: Research Report -->
              <div class="tab-panel" id="tab-report">
                <div
                  style="margin-bottom: 8px; font-size: 12px; color: #9ca3af"
                >
                  Generates a structured note you could share with a PM or in a
                  research channel, based on the current whale snapshot and AI
                  summary.
                </div>
                <div
                  id="report-meta"
                  class="summary-meta"
                  style="display: none; margin-bottom: 8px"
                ></div>
                <button
                  id="report-generate"
                  style="
                    padding: 6px 14px;
                    border-radius: 999px;
                    border: none;
                    font-size: 13px;
                    font-weight: 500;
                    cursor: pointer;
                    background: linear-gradient(135deg, #4b5563, #0ea5e9);
                    color: white;
                    margin-bottom: 10px;
                    box-shadow: 0 6px 20px rgba(15, 23, 42, 0.7);
                  "
                >
                  Generate snapshot note
                </button>
                <span id="report-status" class="loading" style="display: none"
                  >Building note‚Ä¶</span
                >

                <div
                  id="report-body"
                  style="
                    display: none;
                    margin-top: 10px;
                    padding: 10px 12px;
                    border-radius: 12px;
                    background: rgba(15, 23, 42, 0.9);
                    font-size: 13px;
                    line-height: 1.5;
                    color: #e5e7eb;
                    white-space: pre-wrap;
                  "
                ></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- End page container -->
    </div>

    <!-- Floating Ask-AI widget -->
    <div id="chat-widget-panel" class="card">
      <div id="chat-widget-header">
        <div class="card-title" style="margin-bottom: 0">
          Ask AI about these flows
          <span class="badge">Q&amp;A</span>
        </div>
        <button id="chat-close-btn" aria-label="Close chat">√ó</button>
      </div>
      <div style="margin-bottom: 8px; font-size: 12px; color: #9ca3af">
        Ask questions like: ‚ÄúWhy are there so many transfers from this wallet?‚Äù
        or ‚ÄúDoes this look like exchange activity or internal treasury moves?‚Äù
      </div>
      <div style="display: flex; flex-direction: column; gap: 8px">
        <div
          style="
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 6px;
            font-size: 11px;
            color: #9ca3af;
          "
        >
          <span style="opacity: 0.85">Try:</span>
          <button
            class="chat-suggestion"
            data-question="How do I use this dashboard? Please explain what I can do with the table, Flow Intelligence, Wallet Drill-down, and Research Note."
            style="
              padding: 3px 8px;
              border-radius: 999px;
              border: 1px solid rgba(55, 65, 81, 0.9);
              background: rgba(15, 23, 42, 0.9);
              color: #e5e7eb;
              cursor: pointer;
            "
          >
            How do I use this?
          </button>
          <button
            class="chat-suggestion"
            data-question="Are whales in this snapshot mostly accumulating or distributing? Explain briefly."
            style="
              padding: 3px 8px;
              border-radius: 999px;
              border: 1px solid rgba(55, 65, 81, 0.9);
              background: rgba(15, 23, 42, 0.9);
              color: #e5e7eb;
              cursor: pointer;
            "
          >
            Are whales accumulating?
          </button>
        </div>

        <textarea
          id="chat-input"
          rows="3"
          placeholder="Type your question about these whale transfers‚Ä¶"
          style="
            resize: vertical;
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid rgba(55, 65, 81, 0.9);
            background: rgba(15, 23, 42, 0.9);
            color: #e5e7eb;
            font-size: 13px;
            font-family: inherit;
          "
        ></textarea>
        <div style="display: flex; align-items: center; gap: 10px">
          <button
            id="chat-submit"
            style="
              padding: 6px 14px;
              border-radius: 999px;
              border: none;
              font-size: 13px;
              font-weight: 500;
              cursor: pointer;
              background: linear-gradient(135deg, #4f46e5, #06b6d4);
              color: white;
              box-shadow: 0 8px 25px rgba(15, 23, 42, 0.7);
            "
          >
            Ask AI
          </button>
          <span id="chat-status" class="loading" style="display: none"
            >Thinking‚Ä¶</span
          >
        </div>
        <div
          id="chat-answer"
          class="summary-text"
          style="
            display: none;
            border-top: 1px solid rgba(55, 65, 81, 0.7);
            padding-top: 8px;
          "
        ></div>
        <div id="chat-error" class="error" style="display: none"></div>
      </div>
    </div>

    <div id="chat-widget-bubble">üí¨ Ask AI about these flows</div>

    <script>
      let currentTransfers = [];
      let selectedWallet = null;
      let currentWalletStats = null;
      let currentPage = 1;
      let totalPages = 1;
      let summaryTransferCount = 0;
      const PAGE_SIZE = 20;
      let lastNewIds = new Set();
      let isAutoRefreshing = false;
      let lastSeenIds = new Set();

      function shortenAddress(addr) {
        if (!addr || addr.length < 10) return addr || "";
        return addr.slice(0, 6) + "..." + addr.slice(-4);
      }

      function formatLocal(dtString) {
        const dt = new Date(dtString);
        return dt.toLocaleString(undefined, {
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });
      }

      function timeAgo(dtString) {
        const now = new Date();
        const then = new Date(dtString);
        const diff = (now - then) / 1000;

        if (diff < 60) return `${Math.floor(diff)}s ago`;
        if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
        if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
        return `${Math.floor(diff / 86400)}d ago`;
      }

      /* ---------- AI SUMMARY ---------- */
      async function loadSummary() {
        const loadingEl = document.getElementById("summary-loading");
        const textEl = document.getElementById("summary-text");
        const metaEl = document.getElementById("summary-meta");
        const errEl = document.getElementById("summary-error");

        loadingEl.style.display = "block";
        textEl.style.display = "none";
        metaEl.style.display = "none";
        errEl.style.display = "none";

        const limitSelect = document.getElementById("ai-context-limit");
        const limit = limitSelect ? Number(limitSelect.value) : 200;

        try {
          const res = await fetch(`/alerts/summary?limit=${limit}`);
          if (!res.ok) throw new Error("HTTP " + res.status);
          const data = await res.json();

          textEl.textContent = data.summary || "No summary available.";

          summaryTransferCount = data.transfer_count ?? 0;
          const metaText = `Based on ${summaryTransferCount} recent transfers.`;

          metaEl.textContent = metaText;
          loadingEl.style.display = "none";
          textEl.style.display = "block";
          metaEl.style.display = "block";

          const metricsMeta = document.getElementById("metrics-meta");
          if (metricsMeta) {
            metricsMeta.textContent = metaText;
            metricsMeta.style.display = "block";
          }

          const reportMeta = document.getElementById("report-meta");
          if (reportMeta) {
            reportMeta.textContent = metaText;
            reportMeta.style.display = "block";
          }
        } catch (err) {
          console.error(err);
          loadingEl.style.display = "none";
          errEl.textContent = "Could not load AI summary.";
          errEl.style.display = "block";
        }
      }

      /* ---------- FLOW INTELLIGENCE METRICS ---------- */
      function updateMetricsCard() {
        const loadingEl = document.getElementById("metrics-loading");
        const bodyEl = document.getElementById("metrics-body");
        const errEl = document.getElementById("metrics-error");

        const volEl = document.getElementById("metric-volume");
        const largestEl = document.getElementById("metric-largest");
        const uniqEl = document.getElementById("metric-unique-wallets");
        const concEl = document.getElementById("metric-concentration");
        const topListEl = document.getElementById("metric-top-wallets");

        if (!loadingEl) return;

        errEl.style.display = "none";

        if (!currentTransfers || currentTransfers.length === 0) {
          loadingEl.textContent = "No whale data yet for this window.";
          bodyEl.style.display = "none";
          return;
        }

        loadingEl.style.display = "none";
        bodyEl.style.display = "block";

        const TOKENS = ["ETH", "USDC", "USDT", "WBTC"];

        // global unique wallets across all tokens
        const uniqueWallets = new Set();

        // per-token metrics
        const metricsByToken = {};

        TOKENS.forEach((tok) => {
          const subset = currentTransfers.filter(
            (t) => (t.token_symbol || "ETH") === tok,
          );

          if (!subset.length) {
            metricsByToken[tok] = null;
            return;
          }

          let total = 0;
          let largest = 0;
          const walletVolumes = new Map();

          subset.forEach((t) => {
            const amt = Number(t.amount || 0);
            total += amt;
            if (amt > largest) largest = amt;

            if (t.from_address) uniqueWallets.add(t.from_address);
            if (t.to_address) uniqueWallets.add(t.to_address);

            // for concentration we look at *receiving* wallets
            if (t.to_address) {
              walletVolumes.set(
                t.to_address,
                (walletVolumes.get(t.to_address) || 0) + amt,
              );
            }
          });

          const sortedWallets = Array.from(walletVolumes.entries()).sort(
            (a, b) => b[1] - a[1],
          );
          const topWallets = sortedWallets.slice(0, 3);

          let concentration;
          if (!sortedWallets.length || total === 0) {
            concentration = "No large transfers in this snapshot";
          } else {
            const topPct = (sortedWallets[0][1] / total) * 100;
            if (topPct >= 60) {
              concentration = `Highly concentrated (top wallet ‚âà ${topPct.toFixed(
                1,
              )}% of volume)`;
            } else if (topPct >= 35) {
              concentration = `Moderately concentrated (top wallet ‚âà ${topPct.toFixed(
                1,
              )}% of volume)`;
            } else {
              concentration = `Distributed (top wallet ‚âà ${topPct.toFixed(
                1,
              )}% of volume)`;
            }
          }

          metricsByToken[tok] = {
            total,
            largest,
            topWallets,
            concentration,
          };
        });

        // ---- render Unique wallets (combined) ----
        uniqEl.textContent = uniqueWallets.size.toString();

        // ---- render Total volume (one row per token) ----
        volEl.innerHTML = "";
        TOKENS.forEach((tok) => {
          const m = metricsByToken[tok];
          const row = document.createElement("div");
          row.textContent =
            m && m.total > 0
              ? `${tok}: ${m.total.toFixed(2)} ${tok}`
              : `${tok}: ‚Äì`;
          volEl.appendChild(row);
        });

        // ---- render Largest transfer (per token) ----
        largestEl.innerHTML = "";
        TOKENS.forEach((tok) => {
          const m = metricsByToken[tok];
          const row = document.createElement("div");
          row.textContent =
            m && m.largest > 0
              ? `${tok}: ${m.largest.toFixed(2)} ${tok}`
              : `${tok}: ‚Äì`;
          largestEl.appendChild(row);
        });

        // ---- render Concentration (per token) ----
        concEl.innerHTML = "";
        TOKENS.forEach((tok) => {
          const m = metricsByToken[tok];
          const row = document.createElement("div");
          row.textContent = m
            ? `${tok}: ${m.concentration}`
            : `${tok}: No large transfers in this snapshot`;
          concEl.appendChild(row);
        });

        // ---- render Top wallets block (grouped by token) ----
        topListEl.innerHTML = "";
        let anyWallets = false;

        TOKENS.forEach((tok) => {
          const m = metricsByToken[tok];
          if (!m || !m.topWallets.length) return;

          anyWallets = true;

          const header = document.createElement("div");
          header.style.marginTop = "4px";
          header.style.fontWeight = "600";
          header.textContent = tok;
          topListEl.appendChild(header);

          m.topWallets.forEach(([addr, vol], idx) => {
            const line = document.createElement("div");
            line.textContent = `${idx + 1}. ${shortenAddress(
              addr,
            )} ‚Äì ${vol.toFixed(2)} ${tok}`;
            topListEl.appendChild(line);
          });
        });

        if (!anyWallets) {
          topListEl.textContent = "No wallets found.";
        }
      }

      /* ---------- RESEARCH NOTE BUILDER ---------- */
      function buildSnapshotReport() {
        const summaryTextEl = document.getElementById("summary-text");
        const volumeEl = document.getElementById("metric-volume");
        const largestEl = document.getElementById("metric-largest");
        const uniqEl = document.getElementById("metric-unique-wallets");
        const concEl = document.getElementById("metric-concentration");

        const summary =
          summaryTextEl && summaryTextEl.textContent.trim()
            ? summaryTextEl.textContent.trim()
            : "No AI summary available for this snapshot.";

        const totalVol = volumeEl ? volumeEl.textContent.trim() : "n/a";
        const largest = largestEl ? largestEl.textContent.trim() : "n/a";
        const uniq = uniqEl ? uniqEl.textContent.trim() : "n/a";
        const conc = concEl ? concEl.textContent.trim() : "n/a";

        const now = new Date();
        const isoDate = now.toISOString().split("T")[0];
        const timeStr = now.toISOString().split("T")[1].split(".")[0] + " UTC";

        const snapshotCount =
          summaryTransferCount ||
          (currentTransfers ? currentTransfers.length : 0);
        const snapshotLine = `Snapshot based on ${snapshotCount} recent transfers.`;

        const walletVolumes = new Map();
        (currentTransfers || []).forEach((t) => {
          const amt = Number(t.amount || 0);
          if (t.from_address) {
            walletVolumes.set(
              t.from_address,
              (walletVolumes.get(t.from_address) || 0) + amt,
            );
          }
          if (t.to_address) {
            walletVolumes.set(
              t.to_address,
              (walletVolumes.get(t.to_address) || 0) + amt,
            );
          }
        });

        const sorted = Array.from(walletVolumes.entries()).sort(
          (a, b) => b[1] - a[1],
        );
        const top3 = sorted.slice(0, 3);

        let topWalletLines = "None.";
        if (top3.length > 0) {
          topWalletLines = top3
            .map(
              ([addr, vol], idx) =>
                `${idx + 1}. ${shortenAddress(addr)} ‚Äì ${vol.toFixed(2)} ETH`,
            )
            .join("\n");
        }

        const reportLines = [
          `Whale Flow Snapshot ‚Äì ${isoDate} (${timeStr})`,
          snapshotLine,
          "",
          `1) Executive Summary (AI)`,
          summary,
          "",
          `2) Flow Metrics`,
          `‚Ä¢ Total volume: ${totalVol}`,
          `‚Ä¢ Largest transfer: ${largest}`,
          `‚Ä¢ Unique wallets in this snapshot: ${uniq}`,
          `‚Ä¢ Concentration: ${conc}`,
          "",
          `3) Top Whale Wallets (by volume in this snapshot)`,
          topWalletLines,
          "",
          `4) Analyst Notes`,
          `This note is generated from a single snapshot of large transfers in this window.`,
          `For production use, it would be extended with:`,
          `‚Ä¢ wallet labels (exchanges, treasuries, funds)`,
          `‚Ä¢ longer lookback windows and historical context`,
          `‚Ä¢ sentiment / price context (e.g., Tie sentiment scores vs whale behavior).`,
        ];

        return reportLines.join("\n");
      }

      async function sendChatQuestion() {
        const chatInput = document.getElementById("chat-input");
        const answerEl = document.getElementById("chat-answer");
        const statusEl = document.getElementById("chat-status");
        const errEl = document.getElementById("chat-error");
        const limitSelect = document.getElementById("ai-context-limit");
        const limit = limitSelect ? Number(limitSelect.value) : 200;

        const res = await fetch(`/alerts/chat?limit=${limit}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ question }),
        });

        const question = (chatInput.value || "").trim();
        if (!question) return;

        statusEl.style.display = "inline";
        answerEl.style.display = "none";
        errEl.style.display = "none";

        try {
          const res = await fetch("/alerts/chat?limit=20", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              question,
            }),
          });

          if (!res.ok) {
            throw new Error("HTTP " + res.status);
          }

          const data = await res.json();
          // ChatResponse has `answer` and `transfer_count`
          chatInput.value = "";
          answerEl.textContent = data.answer || "No answer returned.";
          answerEl.style.display = "block";
        } catch (err) {
          console.error(err);
          errEl.textContent =
            "Could not get AI answer for this question (check /alerts/chat in your logs).";
          errEl.style.display = "block";
        } finally {
          statusEl.style.display = "none";
        }
      }

      function downloadDataCsv() {
        const rows = currentTransfers || [];
        if (!rows.length) {
          alert("No whale data available to download yet.");
          return;
        }

        const header = [
          "tx_hash",
          "from_address",
          "to_address",
          "token_symbol",
          "amount",
          "block_number",
          "observed_at",
        ];

        const lines = [header.join(",")];

        rows.forEach((t) => {
          const line = [
            t.tx_hash || "",
            t.from_address || "",
            t.to_address || "",
            t.token_symbol || "",
            Number(t.amount || 0),
            t.block_number || "",
            t.observed_at || "",
          ]
            .map((v) => {
              const s = String(v);
              return /[",\n]/.test(s) ? `"${s.replace(/"/g, '""')}"` : s;
            })
            .join(",");

          lines.push(line);
        });

        const blob = new Blob([lines.join("\n")], {
          type: "text/csv;charset=utf-8;",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "whale_transfers_snapshot.csv";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function downloadReportTxt() {
        const reportBody = document.getElementById("report-body");
        const text =
          reportBody && reportBody.textContent.trim().length
            ? reportBody.textContent
            : buildSnapshotReport();

        const blob = new Blob([text], {
          type: "text/plain;charset=utf-8;",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "whale_flow_report.txt";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function printReportPdf() {
        window.print();
      }

      /* ---------- WALLET STATS / PATTERNS ---------- */
      function buildWalletStats(transfers) {
        const stats = {};
        transfers.forEach((t) => {
          const amt = Number(t.amount || 0);
          if (!amt) return;

          if (t.to_address) {
            if (!stats[t.to_address])
              stats[t.to_address] = { inflow: 0, outflow: 0 };
            stats[t.to_address].inflow += amt;
          }
          if (t.from_address) {
            if (!stats[t.from_address])
              stats[t.from_address] = { inflow: 0, outflow: 0 };
            stats[t.from_address].outflow += amt;
          }
        });
        return stats;
      }

      function classifyPatternForTransfer(t, walletStats) {
        const fromStats = t.from_address ? walletStats[t.from_address] : null;
        const toStats = t.to_address ? walletStats[t.to_address] : null;

        let label = "Balanced";
        let title =
          "No strong accumulation / distribution pattern in this snapshot.";

        if (toStats && toStats.inflow > toStats.outflow * 1.5) {
          label = "Accumulator-like";
          title = "Receiving more than it sends across these whale transfers.";
        } else if (fromStats && fromStats.outflow > fromStats.inflow * 1.5) {
          label = "Distributor-like";
          title = "Sending more than it receives across these whale transfers.";
        }

        return { label, title };
      }

      /* ---------- LOAD WHALES + TABLE + PAGINATION ---------- */
      async function loadWhales(isAutoRefresh = false) {
        const loadingEl = document.getElementById("table-loading");
        const tableEl = document.getElementById("whale-table");
        const tbodyEl = document.getElementById("whale-tbody");
        const errEl = document.getElementById("table-error");
        const minAmountInput = document.getElementById("filter-min-amount");
        const minAmount = Number(
          (minAmountInput && minAmountInput.value) || 100,
        );
        const paginationEl = document.getElementById("pagination");

        errEl.style.display = "none";

        if (!isAutoRefresh) {
          loadingEl.style.display = "block";
          loadingEl.textContent = "Loading whale transfers‚Ä¶";
          tableEl.style.display = "none";
          tbodyEl.innerHTML = "";
          if (paginationEl) paginationEl.style.display = "none";
        }

        try {
          const res = await fetch(`/alerts/latest?limit=200`);
          if (!res.ok) throw new Error("HTTP " + res.status);
          const data = await res.json();
          const allRows = data.transfers || [];

          const filteredByAmount = allRows.filter(
            (t) => Number(t.amount || 0) >= minAmount,
          );

          const newIds = new Set();
          if (isAutoRefresh && lastSeenIds.size) {
            filteredByAmount.forEach((t) => {
              if (!lastSeenIds.has(t.tx_hash)) {
                newIds.add(t.tx_hash);
              }
            });
          }
          lastNewIds = newIds;

          lastSeenIds = new Set(filteredByAmount.map((t) => t.tx_hash));

          currentTransfers = filteredByAmount;

          if (currentTransfers.length === 0) {
            loadingEl.textContent =
              "No large ETH transfers match the current filters.";
            updateMetricsCard();
            selectWallet(null);
            return;
          }

          currentWalletStats = buildWalletStats(currentTransfers);

          if (!isAutoRefresh) {
            currentPage = 1;
            selectWallet(null);
          }

          if (!isAutoRefresh) {
            loadingEl.style.display = "none";
          }

          updateMetricsCard();
          renderWhaleTable();
        } catch (err) {
          console.error(err);
          if (!isAutoRefresh) {
            loadingEl.style.display = "none";
            errEl.textContent = "Could not load whale transfers.";
            errEl.style.display = "block";
          }
        } finally {
          if (isAutoRefresh) isAutoRefreshing = false;
        }
      }

      function renderPagination(total) {
        const paginationEl = document.getElementById("pagination");
        const numbersEl = document.getElementById("page-numbers");
        const prevBtn = document.getElementById("page-prev");
        const nextBtn = document.getElementById("page-next");

        if (!paginationEl || !numbersEl || !prevBtn || !nextBtn) return;

        totalPages = total;

        if (totalPages <= 1) {
          paginationEl.style.display = "none";
          return;
        }

        paginationEl.style.display = "flex";

        prevBtn.disabled = currentPage <= 1;
        nextBtn.disabled = currentPage >= totalPages;
        prevBtn.style.opacity = prevBtn.disabled ? 0.5 : 1;
        nextBtn.style.opacity = nextBtn.disabled ? 0.5 : 1;

        numbersEl.innerHTML = "";

        function addPageButton(page) {
          const btn = document.createElement("button");
          btn.className = "page-number-btn";
          btn.textContent = page;
          if (page === currentPage) {
            btn.classList.add("active");
          }
          btn.addEventListener("click", () => {
            if (page === currentPage) return;
            currentPage = page;
            renderWhaleTable();
          });
          numbersEl.appendChild(btn);
        }

        function addEllipsis() {
          const span = document.createElement("span");
          span.className = "page-ellipsis";
          span.textContent = "‚Ä¶";
          numbersEl.appendChild(span);
        }

        if (totalPages <= 7) {
          for (let p = 1; p <= totalPages; p++) addPageButton(p);
          return;
        }

        addPageButton(1);

        const start = Math.max(2, currentPage - 1);
        const end = Math.min(totalPages - 1, currentPage + 1);

        if (start > 2) addEllipsis();

        for (let p = start; p <= end; p++) addPageButton(p);

        if (end < totalPages - 1) addEllipsis();

        addPageButton(totalPages);
      }

      function getActiveTokenSet() {
        const allBtn = document.getElementById("token-all");
        const buttons = document.querySelectorAll(".filter-token-btn");
        const set = new Set();

        if (allBtn && allBtn.classList.contains("active")) {
          return set;
        }

        buttons.forEach((btn) => {
          if (btn === allBtn) return;
          if (btn.classList.contains("active")) {
            const tok = btn.getAttribute("data-token");
            if (tok && tok !== "ALL") {
              set.add(tok.toUpperCase());
            }
          }
        });

        return set;
      }

      function getActivePatternSet() {
        const allBtn = document.getElementById("pattern-all");
        const buttons = document.querySelectorAll(".filter-pattern-btn");
        const set = new Set();

        if (allBtn && allBtn.classList.contains("active")) {
          return set;
        }

        buttons.forEach((btn) => {
          if (btn === allBtn) return;
          if (btn.classList.contains("active")) {
            const label = btn.getAttribute("data-pattern");
            if (label && label !== "ALL") {
              set.add(label);
            }
          }
        });

        return set;
      }

      function renderWhaleTable() {
        const tableEl = document.getElementById("whale-table");
        const tbodyEl = document.getElementById("whale-tbody");
        const loadingEl = document.getElementById("table-loading");
        const errEl = document.getElementById("table-error");
        const paginationEl = document.getElementById("pagination");

        tbodyEl.innerHTML = "";
        errEl.style.display = "none";

        if (!currentTransfers || currentTransfers.length === 0) {
          tableEl.style.display = "none";
          if (paginationEl) paginationEl.style.display = "none";
          return;
        }

        const tokenFilterSet = getActiveTokenSet();
        const patternFilterSet = getActivePatternSet();

        const enriched = currentTransfers.map((t) => {
          const pattern = classifyPatternForTransfer(
            t,
            currentWalletStats || {},
          );
          return { transfer: t, pattern };
        });

        const filtered = enriched.filter(({ transfer: t, pattern }) => {
          const sym = (t.token_symbol || "ETH").toUpperCase();
          if (tokenFilterSet.size && !tokenFilterSet.has(sym)) {
            return false;
          }

          if (patternFilterSet.size && !patternFilterSet.has(pattern.label)) {
            return false;
          }

          return true;
        });

        if (filtered.length === 0) {
          tableEl.style.display = "none";
          loadingEl.style.display = "block";
          loadingEl.textContent = "No transfers match the current filters.";
          if (paginationEl) paginationEl.style.display = "none";
          return;
        }

        const totalPagesLocal = Math.max(
          1,
          Math.ceil(filtered.length / PAGE_SIZE),
        );
        if (currentPage > totalPagesLocal) currentPage = totalPagesLocal;
        if (currentPage < 1) currentPage = 1;

        const start = (currentPage - 1) * PAGE_SIZE;
        const pageItems = filtered.slice(start, start + PAGE_SIZE);

        pageItems.forEach(({ transfer: t, pattern }) => {
          const tr = document.createElement("tr");

          if (currentPage === 1 && lastNewIds.has(t.tx_hash)) {
            tr.classList.add("row-new");
          }

          const amtTd = document.createElement("td");
          amtTd.className = "amount";
          const amtNum = Number(t.amount || 0);
          amtTd.textContent = amtNum.toFixed(4);
          tr.appendChild(amtTd);

          const tokenTd = document.createElement("td");
          tokenTd.textContent = t.token_symbol || "ETH";
          tr.appendChild(tokenTd);

          const fromTd = document.createElement("td");
          fromTd.className = "address";
          if (t.from_address) {
            const a = document.createElement("a");
            a.href = "https://etherscan.io/address/" + t.from_address;
            a.target = "_blank";
            a.rel = "noopener noreferrer";
            a.className = "addr-link";
            a.textContent = shortenAddress(t.from_address);
            a.addEventListener("click", (e) => {
              e.preventDefault();
              selectWallet(t.from_address);
            });
            fromTd.appendChild(a);
          }
          tr.appendChild(fromTd);

          const toTd = document.createElement("td");
          toTd.className = "address";
          if (t.to_address) {
            const a = document.createElement("a");
            a.href = "https://etherscan.io/address/" + t.to_address;
            a.target = "_blank";
            a.rel = "noopener noreferrer";
            a.className = "addr-link";
            a.textContent = shortenAddress(t.to_address);
            a.addEventListener("click", (e) => {
              e.preventDefault();
              selectWallet(t.to_address);
            });
            toTd.appendChild(a);
          }
          tr.appendChild(toTd);

          const patternTd = document.createElement("td");
          const chip = document.createElement("span");
          chip.className = "chip";
          chip.textContent = pattern.label;
          chip.title = pattern.title;
          patternTd.appendChild(chip);
          tr.appendChild(patternTd);

          const blockTd = document.createElement("td");
          blockTd.textContent = t.block_number ?? "";
          tr.appendChild(blockTd);

          const obsTd = document.createElement("td");

          const local = formatLocal(t.observed_at);
          const age = timeAgo(t.observed_at);

          obsTd.innerHTML = `
  <div>${local}</div>
  <div style="font-size: 11px; color: #9ca3af;">${age}</div>
`;

          tr.appendChild(obsTd);

          tbodyEl.appendChild(tr);
        });

        loadingEl.style.display = "none";
        tableEl.style.display = "table";
        renderPagination(totalPagesLocal);
      }

      /* ---------- WALLET DRILL-DOWN ---------- */
      function selectWallet(address) {
        const emptyEl = document.getElementById("wallet-empty");
        const bodyEl = document.getElementById("wallet-body");
        const errEl = document.getElementById("wallet-error");

        const addrEl = document.getElementById("wallet-address");
        const inflowEl = document.getElementById("wallet-inflow");
        const outflowEl = document.getElementById("wallet-outflow");
        const netEl = document.getElementById("wallet-net");
        const txCountEl = document.getElementById("wallet-txcount");
        const roleEl = document.getElementById("wallet-role");

        errEl.style.display = "none";

        if (!address) {
          emptyEl.style.display = "block";
          bodyEl.style.display = "none";
          return;
        }

        selectedWallet = address;

        if (!currentTransfers || currentTransfers.length === 0) {
          errEl.textContent = "No whale data available to analyze this wallet.";
          errEl.style.display = "block";
          return;
        }

        const TOKENS = ["ETH", "USDC", "USDT", "WBTC"];

        // per-token stats for this wallet
        const perToken = {};
        TOKENS.forEach((tok) => {
          perToken[tok] = { inflow: 0, outflow: 0, count: 0 };
        });

        currentTransfers.forEach((t) => {
          const tok = (t.token_symbol || "ETH").toUpperCase();
          if (!perToken[tok]) {
            perToken[tok] = { inflow: 0, outflow: 0, count: 0 };
          }
          const amt = Number(t.amount || 0);
          if (!amt) return;

          if (t.to_address === address) {
            perToken[tok].inflow += amt;
            perToken[tok].count += 1;
          }
          if (t.from_address === address) {
            perToken[tok].outflow += amt;
            perToken[tok].count += 1;
          }
        });

        let totalCount = 0;
        Object.values(perToken).forEach((s) => {
          totalCount += s.count;
        });

        function renderTokenLines(kind, targetEl) {
          targetEl.innerHTML = "";
          let any = false;
          TOKENS.forEach((tok) => {
            const s = perToken[tok];
            if (!s) return;
            let val;
            if (kind === "inflow") val = s.inflow;
            else if (kind === "outflow") val = s.outflow;
            else val = s.inflow - s.outflow; // net

            if (val === 0) return;
            any = true;
            const div = document.createElement("div");
            if (kind === "net") {
              const sign = val > 0 ? "+" : val < 0 ? "‚àí" : "";
              div.textContent = `${tok}: ${sign}${Math.abs(val).toFixed(4)} ${tok}`;
            } else {
              div.textContent = `${tok}: ${val.toFixed(4)} ${tok}`;
            }
            targetEl.appendChild(div);
          });

          if (!any) {
            targetEl.textContent = "No flows in this snapshot.";
          }
        }

        emptyEl.style.display = "none";
        bodyEl.style.display = "block";

        addrEl.innerHTML = "";
        const link = document.createElement("a");
        link.href = "https://etherscan.io/address/" + address;
        link.target = "_blank";
        link.rel = "noopener noreferrer";
        link.className = "addr-link";
        link.textContent = address;
        addrEl.appendChild(link);

        renderTokenLines("inflow", inflowEl);
        renderTokenLines("outflow", outflowEl);
        renderTokenLines("net", netEl);

        txCountEl.textContent = totalCount.toString();

        let totalIn = 0;
        let totalOut = 0;
        Object.values(perToken).forEach((s) => {
          totalIn += s.inflow;
          totalOut += s.outflow;
        });

        let role = "Balanced activity / internal routing";
        if (totalIn > totalOut * 1.2) {
          role = "Net receiver (accumulator) in this snapshot";
        } else if (totalOut > totalIn * 1.2) {
          role = "Net sender (distributor) in this snapshot";
        }

        roleEl.textContent = role;
      }

      /* ---------- TABS ---------- */
      function setActiveTab(tabName) {
        const panels = document.querySelectorAll(".tab-panel");
        const buttons = document.querySelectorAll(".tab-btn");

        panels.forEach((p) => {
          p.classList.toggle("active", p.id === "tab-" + tabName);
        });
        buttons.forEach((b) => {
          b.classList.toggle("active", b.dataset.tab === tabName);
        });
      }

      /* ---------- INIT ---------- */
      window.addEventListener("load", () => {
        loadSummary();
        loadWhales();

        const limitSelect = document.getElementById("ai-context-limit");
        if (limitSelect) {
          limitSelect.addEventListener("change", () => {
            loadSummary();
            loadWhales();
          });
        }
        const applyBtn = document.getElementById("filter-apply");
        const minAmountInput = document.getElementById("filter-min-amount");
        const patternSelect = document.getElementById("filter-pattern");
        const prevBtn = document.getElementById("page-prev");
        const nextBtn = document.getElementById("page-next");

        if (applyBtn) {
          applyBtn.addEventListener("click", () => {
            loadWhales();
          });
        }
        if (minAmountInput) {
          minAmountInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
              e.preventDefault();
              loadWhales();
            }
          });
        }
        if (patternSelect) {
          patternSelect.addEventListener("change", () => {
            currentPage = 1;
            renderWhaleTable();
          });
        }
        if (prevBtn) {
          prevBtn.addEventListener("click", () => {
            if (currentPage > 1) {
              currentPage -= 1;
              renderWhaleTable();
            }
          });
        }
        if (nextBtn) {
          nextBtn.addEventListener("click", () => {
            currentPage += 1;
            renderWhaleTable();
          });
        }

        // Research note button
        const reportButton = document.getElementById("report-generate");
        const reportStatus = document.getElementById("report-status");
        const reportBody = document.getElementById("report-body");
        if (reportButton && reportBody && reportStatus) {
          reportButton.addEventListener("click", () => {
            reportStatus.style.display = "inline";
            reportBody.style.display = "none";
            const text = buildSnapshotReport();
            reportBody.textContent = text;
            reportStatus.style.display = "none";
            reportBody.style.display = "block";
          });
        }

        // Tabs
        document
          .getElementById("tab-btn-overview")
          .addEventListener("click", () => setActiveTab("overview"));
        document
          .getElementById("tab-btn-flow")
          .addEventListener("click", () => setActiveTab("flow"));
        document
          .getElementById("tab-btn-report")
          .addEventListener("click", () => setActiveTab("report"));

        // Chat widget
        const chatBubble = document.getElementById("chat-widget-bubble");
        const chatPanel = document.getElementById("chat-widget-panel");
        const chatClose = document.getElementById("chat-close-btn");
        const chatButton = document.getElementById("chat-submit");
        const chatInput = document.getElementById("chat-input");
        const downloadToggle = document.getElementById("download-menu-toggle");
        const downloadPanel = document.getElementById("download-menu-panel");

        if (downloadToggle && downloadPanel) {
          downloadToggle.addEventListener("click", (e) => {
            e.stopPropagation();
            const open = downloadPanel.style.display === "block";
            downloadPanel.style.display = open ? "none" : "block";
          });

          downloadPanel.addEventListener("click", (e) => {
            const action = e.target.getAttribute("data-action");
            if (action === "data") downloadDataCsv();
            if (action === "report") downloadReportTxt();
            if (action === "pdf") printReportPdf();
            downloadPanel.style.display = "none";
          });

          document.addEventListener("click", (e) => {
            if (
              downloadPanel.style.display === "block" &&
              !downloadPanel.contains(e.target) &&
              e.target !== downloadToggle
            ) {
              downloadPanel.style.display = "none";
            }
          });
        }

        if (chatBubble && chatPanel && chatClose) {
          chatBubble.addEventListener("click", () => {
            chatPanel.style.display = "block";
            chatBubble.style.display = "none";
          });
          chatClose.addEventListener("click", () => {
            chatPanel.style.display = "none";
            chatBubble.style.display = "flex";
          });
        }
        if (chatButton) {
          chatButton.addEventListener("click", sendChatQuestion);
        }
        if (chatInput) {
          chatInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter" && (e.metaKey || e.ctrlKey)) {
              e.preventDefault();
              sendChatQuestion();
            }
          });
        }
        const suggestionButtons = document.querySelectorAll(".chat-suggestion");
        if (suggestionButtons && chatInput) {
          suggestionButtons.forEach((btn) => {
            btn.addEventListener("click", () => {
              const q = btn.getAttribute("data-question") || "";
              chatInput.value = q;
              sendChatQuestion();
            });
          });
        }
        function initMultiPills(groupSelector, allId) {
          const allBtn = document.getElementById(allId);
          const buttons = document.querySelectorAll(groupSelector);
          if (!allBtn || !buttons.length) return;

          // Click ‚ÄúAll‚Äù
          allBtn.addEventListener("click", () => {
            buttons.forEach((b) => b.classList.remove("active"));
            allBtn.classList.add("active");
            currentPage = 1;
            renderWhaleTable();
          });

          // Click individual filters (multi-select)
          buttons.forEach((btn) => {
            if (btn === allBtn) return;
            btn.addEventListener("click", () => {
              btn.classList.toggle("active");
              allBtn.classList.remove("active");

              const anyActive = Array.from(buttons).some(
                (b) => b !== allBtn && b.classList.contains("active"),
              );
              if (!anyActive) {
                allBtn.classList.add("active");
              }

              currentPage = 1;
              renderWhaleTable();
            });
          });
        }

        initMultiPills(".filter-token-btn", "token-all");
        initMultiPills(".filter-pattern-btn", "pattern-all");

        setInterval(() => {
          loadWhales(true);
        }, 60000);
      });
      document.addEventListener("DOMContentLoaded", () => {
        const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
        document.getElementById("tz").textContent = tz;
      });
    </script>
  </body>
</html>
