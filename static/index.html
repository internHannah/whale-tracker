<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>AI Whale Watch</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        font-family:
          system-ui,
          -apple-system,
          BlinkMacSystemFont,
          "Segoe UI",
          sans-serif;
        margin: 0;
        padding: 0;
        background: #050816;
        color: #e5e7eb;
      }

      .page {
        max-width: 960px;
        margin: 0 auto;
        padding: 24px 16px 48px;
      }

      h1 {
        font-size: 28px;
        margin-bottom: 4px;
      }

      .subtitle {
        font-size: 14px;
        color: #9ca3af;
        margin-bottom: 20px;
      }

      .card {
        background: rgba(17, 24, 39, 0.95);
        border-radius: 16px;
        padding: 16px 18px;
        margin-bottom: 20px;
        border: 1px solid rgba(55, 65, 81, 0.8);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.45);
      }

      .card-title {
        font-size: 15px;
        font-weight: 600;
        margin-bottom: 6px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .badge {
        font-size: 11px;
        padding: 2px 6px;
        border-radius: 999px;
        background: rgba(56, 189, 248, 0.15);
        color: #7dd3fc;
        border: 1px solid rgba(56, 189, 248, 0.4);
      }

      .summary-text {
        font-size: 14px;
        line-height: 1.5;
        color: #d1d5db;
        white-space: pre-wrap;
      }

      .summary-meta {
        margin-top: 6px;
        font-size: 12px;
        color: #6b7280;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }

      thead {
        background: rgba(17, 24, 39, 0.95);
      }

      th,
      td {
        padding: 8px 10px;
        text-align: left;
        border-bottom: 1px solid rgba(31, 41, 55, 0.9);
      }

      th {
        font-weight: 500;
        font-size: 12px;
        color: #9ca3af;
      }

      tr:nth-child(even) td {
        background: rgba(15, 23, 42, 0.7);
      }

      .amount {
        font-variant-numeric: tabular-nums;
        font-weight: 500;
        color: #a5b4fc;
      }

      .address {
        font-family:
          ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 12px;
      }

      a.addr-link {
        color: #6ee7b7;
        text-decoration: none;
      }

      a.addr-link:hover {
        text-decoration: underline;
      }

      .chip {
        display: inline-block;
        font-size: 11px;
        padding: 2px 6px;
        border-radius: 999px;
        background: rgba(79, 70, 229, 0.25);
        color: #c4b5fd;
        border: 1px solid rgba(129, 140, 248, 0.6);
      }

      .error {
        color: #fb7185;
        font-size: 13px;
        margin-top: 6px;
      }

      .loading {
        font-size: 13px;
        color: #9ca3af;
      }
      .layout {
        display: flex;
        gap: 18px;
        align-items: flex-start;
      }

      .main-column {
        flex: 2.3; /* wider: ~70% */
        min-width: 0;
      }

      .sidebar {
        flex: 1; /* narrower: ~30% */
        min-width: 260px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

            /* Floating chat widget */
            .chat-widget {
        position: fixed;
        right: 20px;
        bottom: 20px;
        z-index: 50;
      }

      .chat-fab {
        padding: 8px 14px;
        border-radius: 999px;
        border: none;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        background: linear-gradient(135deg, #4f46e5, #06b6d4);
        color: white;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.9);
      }

      .chat-panel {
        position: fixed;
        right: 20px;
        bottom: 60px;
        width: 320px;
        max-height: 60vh;
        background: rgba(15, 23, 42, 0.98);
        border-radius: 16px;
        border: 1px solid rgba(55, 65, 81, 0.9);
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8);
        display: none;
        padding: 12px 14px;
        font-size: 13px;
        color: #e5e7eb;
        display: none;
        flex-direction: column;
        gap: 8px;
      }

      .chat-panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
      }

      .chat-panel-title {
        font-size: 14px;
        font-weight: 600;
      }

      .chat-panel-close {
        border: none;
        background: transparent;
        color: #9ca3af;
        font-size: 16px;
        cursor: pointer;
      }

      /* Make it stack on small screens */
      @media (max-width: 900px) {
        .layout {
          flex-direction: column;
        }
        .sidebar {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <h1>AI Whale Watch</h1>
      <div class="subtitle">
        Real Ethereum whale transfers &amp; AI commentary (mini Tie-style
        prototype).
      </div>

      <div class="layout">
        <!-- ================= LEFT: DATA ================= -->
        <div class="main-column">
          <div class="card">
            <div class="card-title" style="margin-bottom: 6px">
              Recent Whale Transfers
              <span class="chip">ETH &ge; 100</span>
            </div>

            <!-- Filters -->
            <div
              style="
                display: flex;
                flex-wrap: wrap;
                gap: 12px;
                margin-bottom: 8px;
                font-size: 12px;
                color: #9ca3af;
              "
            >
              <div>
                <span>Min amount (ETH): </span>
                <input
                  id="filter-min-amount"
                  type="number"
                  value="100"
                  min="0"
                  step="10"
                  style="
                    width: 80px;
                    padding: 2px 6px;
                    border-radius: 6px;
                    border: 1px solid rgba(55, 65, 81, 0.9);
                    background: rgba(15, 23, 42, 0.9);
                    color: #e5e7eb;
                  "
                />
              </div>
              <div>
                <span>Pattern: </span>
                <select
                  id="filter-pattern"
                  style="
                    padding: 2px 6px;
                    border-radius: 6px;
                    border: 1px solid rgba(55, 65, 81, 0.9);
                    background: rgba(15, 23, 42, 0.9);
                    color: #e5e7eb;
                  "
                >
                  <option value="all">All</option>
                  <option value="Accumulator-like">Accumulator-like</option>
                  <option value="Distributor-like">Distributor-like</option>
                  <option value="Balanced">Balanced</option>
                </select>
              </div>
              <div>
                <button
                  id="filter-apply"
                  style="
                    padding: 4px 10px;
                    border-radius: 999px;
                    border: none;
                    font-size: 12px;
                    font-weight: 500;
                    cursor: pointer;
                    background: linear-gradient(135deg, #4b5563, #0ea5e9);
                    color: white;
                  "
                >
                  Apply
                </button>
              </div>
            </div>

            <!-- Loading / error / table / pagination LIVE INSIDE CARD -->
            <div id="table-loading" class="loading">
              Loading whale transfers‚Ä¶
            </div>
            <div id="table-error" class="error" style="display: none"></div>

            <div style="overflow-x: auto">
              <table id="whale-table" style="display: none">
                <thead>
                  <tr>
                    <th>Amount</th>
                    <th>Token</th>
                    <th>From</th>
                    <th>To</th>
                    <th>Pattern</th>
                    <th>Block</th>
                    <th>Observed</th>
                  </tr>
                </thead>
                <tbody id="whale-tbody"></tbody>
              </table>
            </div>

            <!-- Pagination -->
            <div
              id="pagination"
              style="
                display: none;
                margin-top: 8px;
                font-size: 12px;
                color: #9ca3af;
                justify-content: flex-end;
                align-items: center;
                gap: 8px;
              "
            >
              <button
                id="page-prev"
                style="
                  padding: 3px 8px;
                  border-radius: 999px;
                  border: 1px solid rgba(75, 85, 99, 0.9);
                  background: rgba(15, 23, 42, 0.9);
                  color: #e5e7eb;
                  cursor: pointer;
                "
              >
                Prev
              </button>
              <span id="page-info">Page 1 / 1</span>
              <button
                id="page-next"
                style="
                  padding: 3px 8px;
                  border-radius: 999px;
                  border: 1px solid rgba(75, 85, 99, 0.9);
                  background: rgba(15, 23, 42, 0.9);
                  color: #e5e7eb;
                  cursor: pointer;
                "
              >
                Next
              </button>
            </div>
          </div>
        </div>

        <!-- ================= RIGHT: INTELLIGENCE SIDEBAR ================= -->
        <div class="sidebar">
          <!-- AI summary card -->
          <div class="card" id="summary-card">
            <div class="card-title">
              Market Snapshot
              <span class="badge">AI analysis</span>
            </div>
            <div id="summary-loading" class="loading">Loading summary‚Ä¶</div>
            <div
              id="summary-text"
              class="summary-text"
              style="display: none"
            ></div>
            <div
              id="summary-meta"
              class="summary-meta"
              style="display: none"
            ></div>
            <div id="summary-error" class="error" style="display: none"></div>
          </div>

          <!-- Flow Intelligence metrics -->
          <div class="card" id="metrics-card">
            <div class="card-title" style="margin-bottom: 8px">
              Flow Intelligence
              <span class="badge">Snapshot metrics</span>
            </div>
            <div id="metrics-loading" class="loading">
              Waiting for whale data‚Ä¶
            </div>

            <div
              id="metrics-body"
              style="display: none; font-size: 13px; color: #d1d5db"
            >
              <div
                style="
                  display: flex;
                  flex-wrap: wrap;
                  gap: 12px;
                  margin-bottom: 8px;
                "
              >
                <div>
                  <div style="font-size: 11px; color: #9ca3af">
                    Total volume
                  </div>
                  <div id="metric-volume" style="font-weight: 600">‚Äì</div>
                </div>
                <div>
                  <div style="font-size: 11px; color: #9ca3af">
                    Largest transfer
                  </div>
                  <div id="metric-largest" style="font-weight: 600">‚Äì</div>
                </div>
                <div>
                  <div style="font-size: 11px; color: #9ca3af">
                    Unique wallets
                  </div>
                  <div id="metric-unique-wallets" style="font-weight: 600">
                    ‚Äì
                  </div>
                </div>
                <div>
                  <div style="font-size: 11px; color: #9ca3af">
                    Concentration
                  </div>
                  <div id="metric-concentration" style="font-weight: 600">
                    ‚Äì
                  </div>
                </div>
              </div>

              <div style="margin-top: 4px">
                <div style="font-size: 11px; color: #9ca3af">
                  Top wallets in this snapshot
                </div>
                <div
                  id="metric-top-wallets"
                  style="font-size: 12px; margin-top: 4px"
                ></div>
              </div>
            </div>

            <div id="metrics-error" class="error" style="display: none"></div>
          </div>

          <!-- Wallet Drill-down -->
          <div class="card" id="wallet-card">
            <div class="card-title" style="margin-bottom: 8px">
              Wallet Drill-down
              <span class="badge">Per-wallet view</span>
            </div>
            <div id="wallet-empty" class="loading">
              Click a wallet address in the table to see its flow profile in
              this snapshot.
            </div>
            <div
              id="wallet-body"
              style="display: none; font-size: 13px; color: #d1d5db"
            >
              <div style="margin-bottom: 8px; font-size: 12px; color: #9ca3af">
                Snapshot based on the current set of whale transfers only (not
                full on-chain history).
              </div>
              <div style="margin-bottom: 8px">
                <div style="font-size: 11px; color: #9ca3af">
                  Selected wallet
                </div>
                <div
                  id="wallet-address"
                  class="address"
                  style="font-size: 12px"
                ></div>
              </div>
              <div
                style="
                  display: flex;
                  flex-wrap: wrap;
                  gap: 12px;
                  margin-bottom: 8px;
                "
              >
                <div>
                  <div style="font-size: 11px; color: #9ca3af">
                    Total inflow
                  </div>
                  <div id="wallet-inflow" style="font-weight: 600">‚Äì</div>
                </div>
                <div>
                  <div style="font-size: 11px; color: #9ca3af">
                    Total outflow
                  </div>
                  <div id="wallet-outflow" style="font-weight: 600">‚Äì</div>
                </div>
                <div>
                  <div style="font-size: 11px; color: #9ca3af">Net flow</div>
                  <div id="wallet-net" style="font-weight: 600">‚Äì</div>
                </div>
                <div>
                  <div style="font-size: 11px; color: #9ca3af">
                    Transfers involving wallet
                  </div>
                  <div id="wallet-txcount" style="font-weight: 600">‚Äì</div>
                </div>
              </div>
              <div>
                <div style="font-size: 11px; color: #9ca3af">
                  Role in this flow window
                </div>
                <div
                  id="wallet-role"
                  style="font-weight: 600; font-size: 13px"
                ></div>
              </div>
            </div>
            <div id="wallet-error" class="error" style="display: none"></div>
          </div>

          <!-- Research Note -->
          <div class="card" id="report-card">
            <div class="card-title" style="margin-bottom: 8px">
              Research Note
              <span class="badge">Snapshot report</span>
            </div>
            <div style="margin-bottom: 8px; font-size: 12px; color: #9ca3af">
              Generates a structured note you could share with a PM or in a
              research channel, based on the current whale snapshot and AI
              summary.
            </div>
            <button
              id="report-generate"
              style="
                padding: 6px 14px;
                border-radius: 999px;
                border: none;
                font-size: 13px;
                font-weight: 500;
                cursor: pointer;
                background: linear-gradient(135deg, #4b5563, #0ea5e9);
                color: white;
                margin-bottom: 10px;
                box-shadow: 0 6px 20px rgba(15, 23, 42, 0.7);
              "
            >
              Generate snapshot note
            </button>
            <span id="report-status" class="loading" style="display: none"
              >Building note‚Ä¶</span
            >

            <div
              id="report-body"
              style="
                display: none;
                margin-top: 10px;
                padding: 10px 12px;
                border-radius: 12px;
                background: rgba(15, 23, 42, 0.9);
                font-size: 13px;
                line-height: 1.5;
                color: #e5e7eb;
                white-space: pre-wrap;
              "
            ></div>
          </div>
        </div>
      </div>
    </div>
        <!-- Floating Ask AI widget -->
        <div class="chat-widget">
            <button class="chat-fab" id="chat-toggle">
              üí¨ Ask AI about these flows
            </button>
      
            <div class="chat-panel" id="chat-panel">
              <div class="chat-panel-header">
                <div class="chat-panel-title">Ask AI about these flows</div>
                <button class="chat-panel-close" id="chat-close">&times;</button>
              </div>
              <div style="font-size: 12px; color: #9ca3af; margin-bottom: 4px;">
                Ask things like: ‚ÄúIs this whale accumulating?‚Äù or
                ‚ÄúDoes this look like exchange flow?‚Äù
              </div>
      
              <textarea
                id="chat-input"
                rows="3"
                placeholder="Type your question about these whale transfers‚Ä¶"
                style="
                  resize: vertical;
                  padding: 8px 10px;
                  border-radius: 8px;
                  border: 1px solid rgba(55, 65, 81, 0.9);
                  background: rgba(15, 23, 42, 0.9);
                  color: #e5e7eb;
                  font-size: 13px;
                  font-family: inherit;
                "
              ></textarea>
      
              <div style="display: flex; align-items: center; gap: 10px;">
                <button
                  id="chat-submit"
                  style="
                    padding: 6px 14px;
                    border-radius: 999px;
                    border: none;
                    font-size: 13px;
                    font-weight: 500;
                    cursor: pointer;
                    background: linear-gradient(135deg, #4f46e5, #06b6d4);
                    color: white;
                    box-shadow: 0 8px 25px rgba(15, 23, 42, 0.7);
                  "
                >
                  Ask AI
                </button>
                <span id="chat-status" class="loading" style="display: none;">
                  Thinking‚Ä¶
                </span>
              </div>
      
              <div
                id="chat-answer"
                class="summary-text"
                style="
                  display: none;
                  border-top: 1px solid rgba(55, 65, 81, 0.7);
                  padding-top: 8px;
                "
              ></div>
              <div id="chat-error" class="error" style="display: none;"></div>
            </div>
          </div>      
    <script>
      let currentTransfers = [];
      let selectedWallet = null;
      let currentWalletStats = null;
      let currentPage = 1;
      const PAGE_SIZE = 20;

      function shortenAddress(addr) {
        if (!addr || addr.length < 10) return addr || "";
        return addr.slice(0, 6) + "..." + addr.slice(-4);
      }

      function formatIso(iso) {
        if (!iso) return "";
        // basic trimming: "2025-11-27T00:18:28.376000Z" -> "2025-11-27 00:18:28"
        return iso.replace("T", " ").replace("Z", "").split(".")[0];
      }

      function updateMetricsCard() {
        const loadingEl = document.getElementById("metrics-loading");
        const bodyEl = document.getElementById("metrics-body");
        const errEl = document.getElementById("metrics-error");

        const volEl = document.getElementById("metric-volume");
        const largestEl = document.getElementById("metric-largest");
        const uniqEl = document.getElementById("metric-unique-wallets");
        const concEl = document.getElementById("metric-concentration");
        const topListEl = document.getElementById("metric-top-wallets");

        if (!loadingEl) return; // safety if card not present

        errEl.style.display = "none";

        if (!currentTransfers || currentTransfers.length === 0) {
          loadingEl.textContent = "No whale data yet for this window.";
          bodyEl.style.display = "none";
          return;
        }

        loadingEl.style.display = "none";
        bodyEl.style.display = "block";

        // ---- compute stats ----
        let totalVolume = 0;
        let largest = 0;

        const walletVolumes = new Map();
        const walletSet = new Set();

        currentTransfers.forEach((t) => {
          const amt = Number(t.amount || 0);
          totalVolume += amt;
          if (amt > largest) largest = amt;

          if (t.from_address) {
            walletSet.add(t.from_address);
            walletVolumes.set(
              t.from_address,
              (walletVolumes.get(t.from_address) || 0) + amt,
            );
          }
          if (t.to_address) {
            walletSet.add(t.to_address);
            walletVolumes.set(
              t.to_address,
              (walletVolumes.get(t.to_address) || 0) + amt,
            );
          }
        });

        // sort wallets by volume desc
        const sortedWallets = Array.from(walletVolumes.entries()).sort(
          (a, b) => b[1] - a[1],
        );

        const top3 = sortedWallets.slice(0, 3);
        const topVol = top3.length > 0 ? top3[0][1] : 0;

        // ---- write metrics ----
        volEl.textContent = totalVolume.toFixed(2) + " ETH";
        largestEl.textContent = largest.toFixed(2) + " ETH";
        uniqEl.textContent = walletSet.size.toString();

        if (totalVolume > 0 && top3.length > 0) {
          const pct = (topVol / totalVolume) * 100;
          let concLabel = "";
          if (pct >= 60) concLabel = "Highly concentrated";
          else if (pct >= 35) concLabel = "Moderately concentrated";
          else concLabel = "Distributed";

          concEl.textContent = `${concLabel} (top wallet ‚âà ${pct.toFixed(1)}% of volume)`;
        } else {
          concEl.textContent = "Not enough data.";
        }

        // top 3 wallet list
        if (top3.length === 0) {
          topListEl.textContent = "No wallets found.";
        } else {
          topListEl.innerHTML = "";
          top3.forEach(([addr, vol]) => {
            const div = document.createElement("div");
            div.textContent = `${shortenAddress(addr)} ‚Äì ${vol.toFixed(2)} ETH`;
            topListEl.appendChild(div);
          });
        }
      }

      function buildSnapshotReport() {
        // We‚Äôll pull metrics from the DOM + currentTransfers + summary text
        const summaryTextEl = document.getElementById("summary-text");
        const volumeEl = document.getElementById("metric-volume");
        const largestEl = document.getElementById("metric-largest");
        const uniqEl = document.getElementById("metric-unique-wallets");
        const concEl = document.getElementById("metric-concentration");

        const summary =
          summaryTextEl && summaryTextEl.textContent.trim()
            ? summaryTextEl.textContent.trim()
            : "No AI summary available for this snapshot.";

        const totalVol = volumeEl ? volumeEl.textContent.trim() : "n/a";
        const largest = largestEl ? largestEl.textContent.trim() : "n/a";
        const uniq = uniqEl ? uniqEl.textContent.trim() : "n/a";
        const conc = concEl ? concEl.textContent.trim() : "n/a";

        const now = new Date();
        const isoDate = now.toISOString().split("T")[0];
        const timeStr = now.toISOString().split("T")[1].split(".")[0] + " UTC";

        // Build top wallets section (reuse Flow Intelligence logic)
        const walletVolumes = new Map();
        (currentTransfers || []).forEach((t) => {
          const amt = Number(t.amount || 0);
          if (t.from_address) {
            walletVolumes.set(
              t.from_address,
              (walletVolumes.get(t.from_address) || 0) + amt,
            );
          }
          if (t.to_address) {
            walletVolumes.set(
              t.to_address,
              (walletVolumes.get(t.to_address) || 0) + amt,
            );
          }
        });

        const sorted = Array.from(walletVolumes.entries()).sort(
          (a, b) => b[1] - a[1],
        );
        const top3 = sorted.slice(0, 3);

        let topWalletLines = "None.";
        if (top3.length > 0) {
          topWalletLines = top3
            .map(
              ([addr, vol], idx) =>
                `${idx + 1}. ${shortenAddress(addr)} ‚Äì ${vol.toFixed(2)} ETH`,
            )
            .join("\n");
        }

        const reportLines = [
          `ETH Whale Flow Snapshot ‚Äì ${isoDate} (${timeStr})`,
          "",
          `1) Executive Summary (AI)`,
          summary,
          "",
          `2) Flow Metrics`,
          `‚Ä¢ Total volume: ${totalVol}`,
          `‚Ä¢ Largest transfer: ${largest}`,
          `‚Ä¢ Unique wallets in this snapshot: ${uniq}`,
          `‚Ä¢ Concentration: ${conc}`,
          "",
          `3) Top Whale Wallets (by volume in this snapshot)`,
          topWalletLines,
          "",
          `4) Analyst Notes`,
          `This note is generated from a single snapshot of large ETH transfers.`,
          `For production use, it would be extended with:`,
          `‚Ä¢ wallet labels (exchanges, treasuries, funds)`,
          `‚Ä¢ longer lookback windows and historical context`,
          `‚Ä¢ sentiment / price context (e.g., Tie sentiment scores vs whale behavior).`,
        ];

        return reportLines.join("\n");
      }

      async function loadSummary() {
        const loadingEl = document.getElementById("summary-loading");
        const textEl = document.getElementById("summary-text");
        const metaEl = document.getElementById("summary-meta");
        const errEl = document.getElementById("summary-error");

        loadingEl.style.display = "block";
        textEl.style.display = "none";
        metaEl.style.display = "none";
        errEl.style.display = "none";

        try {
          const res = await fetch("/alerts/summary");
          if (!res.ok) {
            throw new Error("HTTP " + res.status);
          }
          const data = await res.json();
          textEl.textContent = data.summary || "No summary available.";
          metaEl.textContent = `Based on ${data.transfer_count ?? 0} recent transfers.`;
          loadingEl.style.display = "none";
          textEl.style.display = "block";
          metaEl.style.display = "block";
        } catch (err) {
          console.error(err);
          loadingEl.style.display = "none";
          errEl.textContent = "Could not load AI summary.";
          errEl.style.display = "block";
        }
      }

      function buildWalletStats(transfers) {
        // returns { [address]: { inflow, outflow } }
        const stats = {};

        transfers.forEach((t) => {
          const amt = Number(t.amount || 0);
          if (!amt) return;

          if (t.to_address) {
            if (!stats[t.to_address])
              stats[t.to_address] = { inflow: 0, outflow: 0 };
            stats[t.to_address].inflow += amt;
          }
          if (t.from_address) {
            if (!stats[t.from_address])
              stats[t.from_address] = { inflow: 0, outflow: 0 };
            stats[t.from_address].outflow += amt;
          }
        });

        return stats;
      }

      function classifyPatternForTransfer(t, walletStats) {
        const fromStats = t.from_address ? walletStats[t.from_address] : null;
        const toStats = t.to_address ? walletStats[t.to_address] : null;

        // default
        let label = "Balanced";
        let title =
          "No strong accumulation / distribution pattern in this snapshot.";

        // simple heuristics based on net flows:
        // - if to-wallet is strong net receiver => accumulator-like
        // - if from-wallet is strong net sender => distributor-like

        if (toStats && toStats.inflow > toStats.outflow * 1.5) {
          label = "Accumulator-like";
          title = "Receiving more than it sends across these whale transfers.";
        } else if (fromStats && fromStats.outflow > fromStats.inflow * 1.5) {
          label = "Distributor-like";
          title = "Sending more than it receives across these whale transfers.";
        }

        return { label, title };
      }

      async function loadWhales() {
        const loadingEl = document.getElementById("table-loading");
        const tableEl = document.getElementById("whale-table");
        const tbodyEl = document.getElementById("whale-tbody");
        const errEl = document.getElementById("table-error");
        const paginationEl = document.getElementById("pagination");

        const minAmountInput = document.getElementById("filter-min-amount");
        const minAmount = Number(
          (minAmountInput && minAmountInput.value) || 100,
        );

        // reset UI
        loadingEl.style.display = "block";
        loadingEl.textContent = "Loading whale transfers‚Ä¶";
        tableEl.style.display = "none";
        tbodyEl.innerHTML = "";
        errEl.style.display = "none";
        if (paginationEl) paginationEl.style.display = "none";

        try {
          // ask backend for up to 200 rows
          const res = await fetch(
            `/alerts/latest?limit=200&min_amount=${encodeURIComponent(minAmount)}`,
          );
          if (!res.ok) {
            throw new Error("HTTP " + res.status);
          }

          const data = await res.json();
          const rows = data.transfers || [];

          currentTransfers = rows;

          if (rows.length === 0) {
            loadingEl.textContent =
              "No large ETH transfers returned by the provider right now.";
            updateMetricsCard?.();
            selectWallet(null);
            return;
          }

          // build stats once for snapshot
          currentWalletStats = buildWalletStats(rows);
          currentPage = 1;

          loadingEl.style.display = "none";
          updateMetricsCard?.();
          selectedWallet = null;
          selectWallet(null);

          // render first page
          renderWhaleTable();
        } catch (err) {
          console.error(err);
          loadingEl.style.display = "none";
          errEl.textContent = "Could not load whale transfers.";
          errEl.style.display = "block";
        }
      }

      function renderWhaleTable() {
        const tableEl = document.getElementById("whale-table");
        const tbodyEl = document.getElementById("whale-tbody");
        const loadingEl = document.getElementById("table-loading");
        const errEl = document.getElementById("table-error");
        const patternSelect = document.getElementById("filter-pattern");

        const paginationEl = document.getElementById("pagination");
        const pageInfoEl = document.getElementById("page-info");
        const prevBtn = document.getElementById("page-prev");
        const nextBtn = document.getElementById("page-next");

        tbodyEl.innerHTML = "";
        errEl.style.display = "none";

        if (!currentTransfers || currentTransfers.length === 0) {
          tableEl.style.display = "none";
          if (paginationEl) paginationEl.style.display = "none";
          return;
        }

        const patternFilter = (patternSelect && patternSelect.value) || "all";

        // enrich with pattern labels
        const enriched = currentTransfers.map((t) => {
          const pattern = classifyPatternForTransfer(
            t,
            currentWalletStats || {},
          );
          return { transfer: t, pattern };
        });

        // apply pattern filter
        const filtered = enriched.filter((row) => {
          if (patternFilter === "all") return true;
          return row.pattern.label === patternFilter;
        });

        if (filtered.length === 0) {
          tableEl.style.display = "none";
          loadingEl.style.display = "block";
          loadingEl.textContent = "No transfers match the current filters.";
          if (paginationEl) paginationEl.style.display = "none";
          return;
        }

        // pagination math
        const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
        if (currentPage > totalPages) currentPage = totalPages;
        if (currentPage < 1) currentPage = 1;

        const start = (currentPage - 1) * PAGE_SIZE;
        const pageItems = filtered.slice(start, start + PAGE_SIZE);

        // build rows for this page
        pageItems.forEach(({ transfer: t, pattern }) => {
          const tr = document.createElement("tr");

          const amtTd = document.createElement("td");
          amtTd.className = "amount";
          const amtNum = Number(t.amount || 0);
          amtTd.textContent = amtNum.toFixed(4);
          tr.appendChild(amtTd);

          const tokenTd = document.createElement("td");
          tokenTd.textContent = t.token_symbol || "ETH";
          tr.appendChild(tokenTd);

          const fromTd = document.createElement("td");
          fromTd.className = "address";
          if (t.from_address) {
            const a = document.createElement("a");
            a.href = "https://etherscan.io/address/" + t.from_address;
            a.target = "_blank";
            a.rel = "noopener noreferrer";
            a.className = "addr-link";
            a.textContent = shortenAddress(t.from_address);
            a.addEventListener("click", (e) => {
              e.preventDefault();
              selectWallet(t.from_address);
            });
            fromTd.appendChild(a);
          }
          tr.appendChild(fromTd);

          const toTd = document.createElement("td");
          toTd.className = "address";
          if (t.to_address) {
            const a = document.createElement("a");
            a.href = "https://etherscan.io/address/" + t.to_address;
            a.target = "_blank";
            a.rel = "noopener noreferrer";
            a.className = "addr-link";
            a.textContent = shortenAddress(t.to_address);
            a.addEventListener("click", (e) => {
              e.preventDefault();
              selectWallet(t.to_address);
            });
            toTd.appendChild(a);
          }
          tr.appendChild(toTd);

          const patternTd = document.createElement("td");
          const chip = document.createElement("span");
          chip.className = "chip";
          chip.textContent = pattern.label;
          chip.title = pattern.title;
          patternTd.appendChild(chip);
          tr.appendChild(patternTd);

          const blockTd = document.createElement("td");
          blockTd.textContent = t.block_number ?? "";
          tr.appendChild(blockTd);

          const obsTd = document.createElement("td");
          obsTd.textContent = formatIso(t.observed_at);
          tr.appendChild(obsTd);

          tbodyEl.appendChild(tr);
        });

        loadingEl.style.display = "none";
        tableEl.style.display = "table";

        // update pagination UI
        if (paginationEl && pageInfoEl && prevBtn && nextBtn) {
          paginationEl.style.display = "flex";
          pageInfoEl.textContent = `Page ${currentPage} / ${totalPages}`;

          prevBtn.disabled = currentPage <= 1;
          nextBtn.disabled = currentPage >= totalPages;
          prevBtn.style.opacity = prevBtn.disabled ? 0.5 : 1;
          nextBtn.style.opacity = nextBtn.disabled ? 0.5 : 1;
        }
      }

      async function sendChatQuestion() {
        const inputEl = document.getElementById("chat-input");
        const statusEl = document.getElementById("chat-status");
        const answerEl = document.getElementById("chat-answer");
        const errEl = document.getElementById("chat-error");

        const question = (inputEl.value || "").trim();
        if (!question) {
          errEl.textContent = "Please type a question first.";
          errEl.style.display = "block";
          answerEl.style.display = "none";
          return;
        }

        // reset states
        errEl.style.display = "none";
        answerEl.style.display = "none";
        statusEl.style.display = "inline";

        try {
          const res = await fetch("/alerts/chat?limit=20", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ question }),
          });

          if (!res.ok) {
            throw new Error("HTTP " + res.status);
          }

          const data = await res.json();
          answerEl.textContent = data.answer || "No answer returned.";
          answerEl.style.display = "block";
        } catch (err) {
          console.error(err);
          errEl.textContent = "Could not get an answer from AI.";
          errEl.style.display = "block";
        } finally {
          statusEl.style.display = "none";
        }
      }

      function selectWallet(address) {
        const emptyEl = document.getElementById("wallet-empty");
        const bodyEl = document.getElementById("wallet-body");
        const errEl = document.getElementById("wallet-error");

        const addrEl = document.getElementById("wallet-address");
        const inflowEl = document.getElementById("wallet-inflow");
        const outflowEl = document.getElementById("wallet-outflow");
        const netEl = document.getElementById("wallet-net");
        const txCountEl = document.getElementById("wallet-txcount");
        const roleEl = document.getElementById("wallet-role");

        errEl.style.display = "none";

        if (!address) {
          emptyEl.style.display = "block";
          bodyEl.style.display = "none";
          return;
        }

        selectedWallet = address;

        if (!currentTransfers || currentTransfers.length === 0) {
          errEl.textContent = "No whale data available to analyze this wallet.";
          errEl.style.display = "block";
          return;
        }

        let inflow = 0;
        let outflow = 0;
        let count = 0;
        currentTransfers.forEach((t) => {
          const amt = Number(t.amount || 0);
          if (t.to_address === address) {
            inflow += amt;
            count += 1;
          }
          if (t.from_address === address) {
            outflow += amt;
            count += 1;
          }
        });

        emptyEl.style.display = "none";
        bodyEl.style.display = "block";
        addrEl.innerHTML = "";
        const link = document.createElement("a");
        link.href = "https://etherscan.io/address/" + address;
        link.target = "_blank";
        link.rel = "noopener noreferrer";
        link.className = "addr-link";
        link.textContent = address;
        addrEl.appendChild(link);

        inflowEl.textContent = inflow.toFixed(4) + " ETH";
        outflowEl.textContent = outflow.toFixed(4) + " ETH";

        const net = inflow - outflow;
        const sign = net > 0 ? "+" : net < 0 ? "‚àí" : "";
        netEl.textContent = sign + Math.abs(net).toFixed(4) + " ETH";

        txCountEl.textContent = count.toString();

        // simple heuristic role label
        let role = "Balanced activity / internal routing";
        if (inflow > outflow * 1.2) {
          role = "Net receiver (accumulator) in this snapshot";
        } else if (outflow > inflow * 1.2) {
          role = "Net sender (distributor) in this snapshot";
        }

        roleEl.textContent = role;
      }

      // Load both on page load
      window.addEventListener("load", () => {
        const reportButton = document.getElementById("report-generate");
        const reportStatus = document.getElementById("report-status");
        const reportBody = document.getElementById("report-body");
        const applyBtn = document.getElementById("filter-apply");
        const minAmountInput = document.getElementById("filter-min-amount");
        const patternSelect = document.getElementById("filter-pattern");
        const prevBtn = document.getElementById("page-prev");
        const nextBtn = document.getElementById("page-next");
        const chatButton = document.getElementById("chat-submit");
        const chatInput = document.getElementById("chat-input");
        const chatToggle = document.getElementById("chat-toggle");
        const chatPanel = document.getElementById("chat-panel");
        const chatClose = document.getElementById("chat-close");

        if (chatToggle && chatPanel) {
          chatToggle.addEventListener("click", () => {
            const isOpen = chatPanel.style.display === "flex";
            if (isOpen) {
              chatPanel.style.display = "none";
            } else {
              chatPanel.style.display = "flex";
            }
          });
        }

        if (chatClose && chatPanel) {
          chatClose.addEventListener("click", () => {
            chatPanel.style.display = "none";
          });
        }

        if (reportButton && reportBody && reportStatus) {
          reportButton.addEventListener("click", () => {
            // simple UX: show "building", then populate
            reportStatus.style.display = "inline";
            reportBody.style.display = "none";

            // no async needed; everything is local
            const text = buildSnapshotReport();
            reportBody.textContent = text;

            reportStatus.style.display = "none";
            reportBody.style.display = "block";
          });
        }
        loadSummary();
        loadWhales();
        if (applyBtn) {
          applyBtn.addEventListener("click", () => {
            loadWhales();
          });
        }

        if (applyBtn) {
          applyBtn.addEventListener("click", () => {
            loadWhales(); // refetch from backend
          });
        }

        if (minAmountInput) {
          minAmountInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
              e.preventDefault();
              loadWhales(); // new min amount => new snapshot
            }
          });
        }

        if (patternSelect) {
          patternSelect.addEventListener("change", () => {
            currentPage = 1; // reset to first page
            renderWhaleTable(); // no refetch needed; just re-slice
          });
        }

        if (prevBtn) {
          prevBtn.addEventListener("click", () => {
            if (currentPage > 1) {
              currentPage -= 1;
              renderWhaleTable();
            }
          });
        }

        if (nextBtn) {
          nextBtn.addEventListener("click", () => {
            currentPage += 1;
            renderWhaleTable();
          });
        }

        if (chatButton) {
          chatButton.addEventListener("click", sendChatQuestion);
        }

        if (chatInput) {
          chatInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter" && (e.metaKey || e.ctrlKey)) {
              e.preventDefault();
              sendChatQuestion();
            }
          });
        }
      });
    </script>
  </body>
</html>
